import {format,transports,createLogger}from'winston';import'winston-daily-rotate-file';import C from'jsonwebtoken';import M from'bcrypt';import b from'crypto';var O=Object.defineProperty;var a=(t,e)=>{for(var o in e)O(t,o,{get:e[o],enumerable:true});};var v={};a(v,{authentication:()=>g,errorHandler:()=>u,responseHandler:()=>T,routeLogger:()=>R,validateSchema:()=>w});var x={};a(x,{ANSI:()=>l,colorize:()=>m,logger:()=>f});var l=(n=>(n.RESET="\x1B[0m",n.FAINT="\x1B[2m",n.RED="\x1B[31m",n.GREEN="\x1B[32m",n.YELLOW="\x1B[33m",n.BLUE="\x1B[34m",n.MAGENTA="\x1B[35m",n.BOLD_RED="\x1B[1;31m",n))(l||{}),m=(t,e)=>`${e}${t}\x1B[0m`;var k=format.combine(format.timestamp(),format(t=>(t.level=t.level.toUpperCase().padStart(7),t))()),B=new transports.Console({format:format.combine(k,format.colorize(),format.printf(t=>{let e=t.message;return [m(t.timestamp,"\x1B[2m"),t.level,m(`[${e.ip??e.socket.remoteAddress??"unknown"}]`,"\x1B[35m"),m(e.method,"\x1B[33m"),e.path].join(" ")}))}),$=new transports.DailyRotateFile({format:format.combine(k,format.printf(t=>{let e=t.message;return [t.timestamp,t.level,`[${e.ip??e.socket.remoteAddress??"unknown"}]`,e.method,e.path].join(" ")})),auditFile:"logs/.audit",filename:"logs/%DATE%.log",maxFiles:"28d"}),f=createLogger({level:"debug",transports:[B,$],handleExceptions:true,handleRejections:true});var R=(t,e,o)=>{f.info(t),o();};var T=(t,e,o)=>{e.ok=r=>{e.json({data:r});},o();};var u={};a(u,{api:()=>A,www:()=>_});var A=(t,e,o,r)=>{o.statusCode===200&&o.status(500),t instanceof Error&&JSON.stringify(t)==="{}"?o.json({error:{name:t.name,message:t.message}}):o.json({error:t});};var _=(t,e)=>(o,r,s,p)=>{let i=typeof t=="string"?t:t?.[s.statusCode],d=(typeof e=="string"?e:e?.[s.statusCode])??(o instanceof Error?o.message:"Unknown error");s.send(`
    <script>
      alert("${d}");
      ${i?`window.location.replace("${i}")`:"history.back()"}
    </script>
  `);};var g={};a(g,{jwt:()=>D,local:()=>z});var z=(t,e,o)=>{let r=t.ip??t.socket.remoteAddress;if(r!=="::1"&&r!=="localhost")throw e.status(401),new Error("Unauthorized");o();};var D=(t,e,o={})=>(r,s,p)=>{try{r.jwt=Object.assign(C.verify(t,e,Object.assign(o,{complete:!0})),{raw:t});}catch(i){throw s.status(401),i}p();};var w={};a(w,{joi:()=>F,superstruct:()=>H,zod:()=>q});var F=t=>async(e,o,r)=>{try{e.body=await t.validateAsync(e.body);}catch(s){throw o.status(422),s}r();};var H=t=>(e,o,r)=>{try{e.body=t.create(e.body);}catch(s){throw o.status(422),s}r();};var q=t=>async(e,o,r)=>{try{e.body=await t.parseAsync(e.body);}catch(s){throw o.status(422),s}r();};var L={};a(L,{logging:()=>x,password:()=>E});var E={};a(E,{bcrypt:()=>y,hmac:()=>h});var y={};a(y,{hash:()=>U,verify:()=>G});var U=async t=>M.hash(t,10),G=async(t,e)=>M.compare(t,e);var h={};a(h,{hash:()=>P,verify:()=>J});var P=(t,e="sha256",o="base64")=>{let r=b.randomBytes(16),s=b.createHmac(e,r).update(t);return Buffer.concat([r,s.digest()]).toString(o)},J=(t,e,o="sha256",r="base64")=>{let s=Buffer.from(e,r),[p,i]=[s.subarray(0,16),s.subarray(16)],d=b.createHmac(o,p).update(t);return i.toString(r)===d.digest(r)};export{v as middleware,L as utils};